name: full-scan

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain (e.g. example.com)'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Prepare Go env and PATH
        run: |
          mkdir -p "$HOME/go/bin"
          echo "GOPATH=$HOME/go" >> $GITHUB_ENV
          echo "GOBIN=$HOME/go/bin" >> $GITHUB_ENV
          echo "$HOME/go/bin" >> $GITHUB_PATH
          echo "Prepared GOPATH and GOBIN"

      - name: Install system deps and Go tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl git python3-pip
          # correct module paths (case-sensitive)
          GO111MODULE=on go install github.com/owasp-amass/amass/v3/...@latest
          GO111MODULE=on go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          GO111MODULE=on go install github.com/tomnomnom/assetfinder@latest
          GO111MODULE=on go install github.com/lc/gau/v2/cmd/gau@latest || true
          GO111MODULE=on go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          GO111MODULE=on go install github.com/projectdiscovery/naabu/v2/cmd/naabu@latest || true
          GO111MODULE=on go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          GO111MODULE=on go install github.com/ffuf/ffuf@latest || true
          echo "Go tools installed."

      - name: Validate secrets and input
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "::error::DISCORD_WEBHOOK secret not set"
            exit 1
          fi
          if [ "${{ secrets.SCAN_AUTH }}" != "AUTHORIZED" ]; then
            echo "::error::You must set SCAN_AUTH repo secret to AUTHORIZED"
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV
          echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV
          echo "Secrets validated"

      - name: Notify start (Discord)
        run: |
          MSG="ðŸ” Scan started for $DOMAIN â€” active enumeration & fuzzing may run. Ensure written authorization."
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"$MSG\"}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Enumerate subdomains and URLs (passive + active amass)
        run: |
          set -euo pipefail
          mkdir -p tmp
          echo "[*] amass passive..."
          amass enum -passive -d "$DOMAIN" -o tmp/amass_passive.txt 2>/dev/null || true
          echo "[*] subfinder..."
          subfinder -d "$DOMAIN" -silent -o tmp/subfinder.txt 2>/dev/null || true
          echo "[*] assetfinder..."
          assetfinder --subs-only "$DOMAIN" > tmp/assetfinder.txt 2>/dev/null || true
          echo "[*] crt.sh..."
          curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/\*\.//g' > tmp/crtsh.txt || true
          # combine and dedupe
          cat tmp/amass_passive.txt tmp/subfinder.txt tmp/assetfinder.txt tmp/crtsh.txt | sed 's/\*\.//g' | grep -E "\.${DOMAIN}$" | sort -u > tmp/subdomains.txt || true
          # active amass (noisy) - run but safe defaults
          echo "[*] amass active (noisy) - running with limits..."
          amass enum -active -d "$DOMAIN" -o tmp/amass_active.txt -min-for-recursive 2 || true
          if [ -s tmp/amass_active.txt ]; then
            cat tmp/amass_active.txt >> tmp/subdomains.txt || true
            sort -u tmp/subdomains.txt -o tmp/subdomains.txt || true
          fi
          # gather historical URLs via gau if available
          if command -v gau >/dev/null 2>&1; then
            gau "$DOMAIN" > tmp/gau.txt 2>/dev/null || true
            grep "$DOMAIN" tmp/gau.txt | sort -u > tmp/urls.txt || true
          else
            touch tmp/urls.txt
          fi
          echo "Subdomains count: $(wc -l < tmp/subdomains.txt || echo 0)"
          echo "URLs count: $(wc -l < tmp/urls.txt || echo 0)"
          echo "SUBS_COUNT=$(wc -l < tmp/subdomains.txt || echo 0)" >> $GITHUB_ENV
          echo "URLS_COUNT=$(wc -l < tmp/urls.txt || echo 0)" >> $GITHUB_ENV

      - name: Probe alive URLs/hosts with httpx
        run: |
          set -euo pipefail
          mkdir -p tmp
          if [ -s tmp/urls.txt ]; then
            cat tmp/urls.txt | httpx -silent -threads 50 -o tmp/httpx_results.txt || true
            awk '{print $1}' tmp/httpx_results.txt | sort -u > tmp/urls_alive.txt || true
          else
            cat tmp/subdomains.txt | sed 's/$/\/ /' | httpx -silent -threads 50 -o tmp/httpx_results.txt || true
            awk '{print $1}' tmp/httpx_results.txt | sort -u > tmp/urls_alive.txt || true
          fi
          echo "ALIVE_COUNT=$(wc -l < tmp/urls_alive.txt || echo 0)" >> $GITHUB_ENV

      - name: Update nuclei templates and run nuclei
        run: |
          set -euo pipefail
          nuclei -ut || true
          if [ -s tmp/urls_alive.txt ]; then
            nuclei -l tmp/urls_alive.txt -severity critical,high,medium -o tmp/nuclei_results.txt -c 50 || true
          else
            echo "No targets for nuclei" > tmp/nuclei_results.txt
          fi
          sort -u tmp/nuclei_results.txt -o tmp/nuclei_results_dedup.txt || true
          echo "NUCLEI_COUNT=$(wc -l < tmp/nuclei_results_dedup.txt || echo 0)" >> $GITHUB_ENV

      - name: Run ffuf on sensitive endpoints (noisy)
        run: |
          set -euo pipefail
          mkdir -p tmp/ffuf
          # extract sensitive endpoints from alive URLs
          grep -E '\?.*=|/login|/admin|/dashboard|/wp-admin|/api/|/oauth|/token|/auth|\.js$' tmp/urls_alive.txt | sort -u > tmp/sensitive.txt || true
          if [ ! -s tmp/sensitive.txt ]; then
            # build root endpoints if none found
            awk -F/ '{print $1"//"$3"/"}' tmp/urls_alive.txt | sort -u > tmp/roots.txt || true
            while read -r r; do
              echo "${r}admin" >> tmp/sensitive.txt
              echo "${r}login" >> tmp/sensitive.txt
              echo "${r}dashboard" >> tmp/sensitive.txt
            done < tmp/roots.txt || true
          fi
          # download lightweight wordlists
          WL_DIR=/tmp/ffuf_wl
          mkdir -p "$WL_DIR"
          curl -s -L https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt -o "$WL_DIR/common.txt" || true
          BATCH=3
          split -l $BATCH tmp/sensitive.txt tmp/batch_ || true
          for b in tmp/batch_*; do
            while read -r target; do
              [ -z "$target" ] && continue
              if echo "$target" | grep -q '\?'; then
                FUZZ_URL=$(echo "$target" | sed -E 's/([?&][^=]+=)[^&]*/\1FUZZ/')
              else
                FUZZ_URL="${target}FUZZ"
              fi
              SAFE=$(echo "$target" | sed -E 's/[^a-zA-Z0-9]/_/g' | cut -c1-80)
              OUT_JSON="tmp/ffuf/${SAFE}.json"
              ffuf -u "$FUZZ_URL" -w "$WL_DIR/common.txt" -t 12 -timeout 8 -mc 200,301,302,401,403 -of json -o "$OUT_JSON" || true
              sleep 1
            done < "$b"
            sleep 3
          done || true

      - name: Postprocess ffuf summary
        run: |
          > tmp/ffuf_summary.txt || true
          for f in tmp/ffuf/*.json 2>/dev/null; do
            [ -f "$f" ] || continue
            echo "=== $(basename "$f") ===" >> tmp/ffuf_summary.txt
            jq -r '.results[]? | "\(.status) \(.input) \(.url)"' < "$f" >> tmp/ffuf_summary.txt || true
          done || true

      - name: Notify summary (Discord)
        run: |
          SUBS=${SUBS_COUNT:-0}
          URLS=${URLS_COUNT:-0}
          ALIVE=${ALIVE_COUNT:-0}
          NUCLEI=${NUCLEI_COUNT:-0}
          FFUF_FILES=$(ls tmp/ffuf 2>/dev/null | wc -l || echo 0)
          SUMMARY="ðŸ“Š Scan summary for $DOMAIN\nSubdomains: $SUBS\nURLs: $URLS\nAlive: $ALIVE\nNuclei findings (deduped): $NUCLEI\nFFUF result files: $FFUF_FILES"
          curl -s -X POST -H "Content-Type: application/json" -d "{\"content\":\"$SUMMARY\"}" "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ github.run_id }}
          path: |
            tmp/subdomains.txt
            tmp/urls.txt
            tmp/urls_alive.txt
            tmp/nuclei_results.txt
            tmp/nuclei_results_dedup.txt
            tmp/ffuf
            tmp/ffuf_summary.txt
