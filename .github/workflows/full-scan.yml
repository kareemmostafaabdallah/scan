name: full-scan

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain'
        required: true
        default: 'example.com'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Prepare Go environment
        run: |
          export GOPATH="$HOME/go"
          export GOBIN="$HOME/go/bin"
          mkdir -p "$GOBIN"
          echo "GOPATH=$GOPATH" >> $GITHUB_ENV
          echo "GOBIN=$GOBIN" >> $GITHUB_ENV
          echo "$GOBIN" >> $GITHUB_PATH
          echo "Prepared Go env at $GOBIN"

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl git
          go install github.com/OWASP/Amass/v3/...@latest
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/ffuf/ffuf@latest

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "::error::DISCORD_WEBHOOK not set"
            exit 1
          fi
          if [ "${{ secrets.SCAN_AUTH }}" != "AUTHORIZED" ]; then
            echo "::error::You must set SCAN_AUTH=AUTHORIZED"
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV
          echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          MSG="ðŸ” Starting scan for $DOMAIN"
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"$MSG\"}" "${{ env.DISCORD_WEBHOOK }}"

      - name: Enumerate Subdomains
        run: |
          mkdir -p tmp
          amass enum -passive -d "$DOMAIN" -o tmp/amass.txt || true
          subfinder -d "$DOMAIN" -silent -o tmp/subfinder.txt
          sort -u tmp/amass.txt tmp/subfinder.txt > tmp/subdomains.txt
          echo "SUBS=$(wc -l < tmp/subdomains.txt)" >> $GITHUB_ENV

      - name: Probe Alive
        run: |
          httpx -l tmp/subdomains.txt -silent -o tmp/alive.txt
          echo "ALIVE=$(wc -l < tmp/alive.txt)" >> $GITHUB_ENV

      - name: Run Nuclei
        run: |
          nuclei -ut
          nuclei -l tmp/alive.txt -severity critical,high,medium -o tmp/nuclei.txt
          echo "NUCLEI=$(wc -l < tmp/nuclei.txt)" >> $GITHUB_ENV

      - name: FFUF Sensitive Paths
        run: |
          mkdir -p tmp/ffuf
          grep -E "/(admin|login|dashboard|auth|api)" tmp/alive.txt > tmp/sensitive.txt || true
          while read -r url; do
            [ -z "$url" ] && continue
            safe=$(echo "$url" | sed 's#[^a-zA-Z0-9]#_#g')
            ffuf -u "${url%/}/FUZZ" -w /usr/share/wordlists/dirb/common.txt -mc 200,301,302,403 \
              -t 20 -of json -o tmp/ffuf/${safe}.json || true
          done < tmp/sensitive.txt

      - name: Notify Summary
        run: |
          MSG="âœ… Scan complete for $DOMAIN\nSubdomains: $SUBS\nAlive: $ALIVE\nFindings: $NUCLEI"
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"$MSG\"}" "${{ env.DISCORD_WEBHOOK }}"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: tmp/
