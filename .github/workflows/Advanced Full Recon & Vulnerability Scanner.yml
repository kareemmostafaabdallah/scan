name: Advanced Full Recon & Vulnerability Scanner

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan (e.g., example.com)'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1' # Run every Monday 6 AM UTC

jobs:
  recon:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go Environment
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y jq git make gcc curl

          # Install massdns manually (not available in apt)
          git clone https://github.com/blechschmidt/massdns.git
          cd massdns
          make
          sudo cp bin/massdns /usr/local/bin/
          cd ..

          # Add Go bin to PATH
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

          # Install Go-based tools
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/chaos-client/cmd/chaos@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

      - name: Validate Discord Webhook Secret
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "::error::DISCORD_WEBHOOK secret is not set!"
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV

      - name: Set Domain
        id: domain
        run: echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"ðŸš€ **Full Recon Started!**\\n**Domain:** ${{ env.DOMAIN }}\\nTools: Subfinder, Chaos, MassDNS, Nuclei\"}" \
          "${{ env.DISCORD_WEBHOOK }}"

      - name: Subfinder Scan
        run: |
          subfinder -d ${{ env.DOMAIN }} -all -silent -o subfinder.txt
          echo "Subfinder results: $(wc -l < subfinder.txt)"

      - name: Chaos Scan
        env:
          CHAOS_KEY: ${{ secrets.CHAOS_KEY }}
        run: |
          if [ -n "$CHAOS_KEY" ]; then
            chaos -d ${{ env.DOMAIN }} -silent -key $CHAOS_KEY -o chaos.txt
          else
            echo "No CHAOS_KEY found, skipping Chaos scan" > chaos.txt
          fi

      - name: Merge & Resolve DNS
        run: |
          cat subfinder.txt chaos.txt | sort -u > all_subs.txt
          echo "Total subdomains before DNS resolution: $(wc -l < all_subs.txt)"
          massdns -r /etc/resolv.conf -t A -o S all_subs.txt | tee resolved.txt
          awk '{print $1}' resolved.txt | sed 's/\.$//' > alive.txt
          echo "Resolved subdomains: $(wc -l < alive.txt)" >> $GITHUB_ENV

      - name: Nuclei Scan
        run: |
          nuclei -l alive.txt -severity critical,high,medium -silent -o nuclei.txt
          echo "Vulnerabilities found: $(wc -l < nuclei.txt)" >> $GITHUB_ENV

      - name: Discord Summary
        run: |
          SUBS=$(wc -l < alive.txt)
          VULNS=$(wc -l < nuclei.txt)
          curl -X POST -H "Content-Type: application/json" \
          -d "{\"content\": \"âœ… **Scan Complete!**\\n**Domain:** ${{ env.DOMAIN }}\\n**Alive Subdomains:** $SUBS\\n**Vulnerabilities Found:** $VULNS\"}" \
          "${{ env.DISCORD_WEBHOOK }}"

      - name: Send Vulnerabilities (if any)
        if: success()
        run: |
          if [ -s nuclei.txt ]; then
            while IFS= read -r vuln; do
              curl -X POST -H "Content-Type: application/json" \
                -d "{\"content\": \"ðŸš¨ **Vulnerability Found**\\n\\n\`\`\`$vuln\`\`\`\"}" \
                "${{ env.DISCORD_WEBHOOK }}"
              sleep 1
            done < nuclei.txt
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: recon-results
          path: |
            subfinder.txt
            chaos.txt
            resolved.txt
            alive.txt
            nuclei.txt
