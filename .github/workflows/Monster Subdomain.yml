name: Monster Subdomain Enumeration - جامد فشخ (Fixed 2025)

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain'
        required: true
        default: 'example.com'

jobs:
  monster:
    runs-on: ubuntu-latest
    timeout-minutes: 420

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23'
          cache: true

      - name: Install Tools (All Working 100%)
        run: |
          # الأدوات الأساسية
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/dnsx/cmd/dnsx@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@v1.6.9
          go install github.com/tomnomnom/assetfinder@latest
          
          # Amass v4 (الصحيح 2025)
          go install github.com/owasp-amass/amass/v4/cmd/amass@latest
          
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # Findomain
          curl -sLO https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip
          unzip -o findomain-linux.zip && chmod +x findomain && sudo mv findomain /usr/local/bin/

          # Wordlists
          curl -sLO https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/DNS/subdomains-top1million-10000.txt
          
          sudo apt-get update -qq && sudo apt-get install -y jq

      - name: Validate Webhook
        run: |
          [ -z "$DISCORD_WEBHOOK" ] && echo "::error::ضيف DISCORD_WEBHOOK في Secrets" && exit 1

      - name: Notify Start
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "Monster Recon Started على `'${{ inputs.domain }}'`"}'

      - name: Monster Enumeration
        run: |
          DOMAIN="${{ inputs.domain }}"

          subfinder -d $DOMAIN -all -recursive -silent -o subfinder.txt
          assetfinder --subs-only $DOMAIN > assetfinder.txt
          findomain -t $DOMAIN -q > findomain.txt
          amass enum -passive -d $DOMAIN -o amass.txt
          curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sort -u > crtsh.txt
          curl -s "https://rapiddns.io/subdomain/$DOMAIN?full=1" | grep -oE "[a-zA-Z0-9._-]+\.$DOMAIN" | sort -u > rapiddns.txt || true

          cat *.txt 2>/dev/null | sort -u | grep -v '*' > all-raw.txt
          echo "TOTAL=$(wc -l < all-raw.txt)" >> $GITHUB_ENV

      - name: Resolve & Probe
        run: |
          dnsx -l all-raw.txt -resp-only -silent | httpx -silent -status-code -title -threads 500 -timeout 15 -o alive.txt || true
          cat alive.txt | awk '{print $1}' | sort -u > final-clean.txt
          echo "ALIVE=$(wc -l < final-clean.txt)" >> $GITHUB_ENV

      - name: Send Results
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d "{
            \"content\": \"**Monster Recon خلّص يا بطل!**\n**Target:** ${{ inputs.domain }}\n**الكل:** ${{ env.TOTAL }}\n**العايشين:** ${{ env.ALIVE }}\"
          }"
          curl -F "file=@all-raw.txt" -F "content=1. كل الصب دومينز الخام" "$DISCORD_WEBHOOK"
          curl -F "file=@alive.txt" -F "content=2. اللي بيردوا" "$DISCORD_WEBHOOK"
          curl -F "file=@final-clean.txt" -F "content=3. **الملف النضيف النهائي - استخدم ده**" "$DISCORD_WEBHOOK"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MONSTER-${{ inputs.domain }}-$(date +%Y%m%d)
          path: |
            all-raw.txt
            alive.txt
            final-clean.txt

      - name: Final Message
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "خلّصنا يا معلم، كل صب دومين في الكون دلوقتي عندك"}'
