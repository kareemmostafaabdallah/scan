name: Recon + Katana 

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain (Ù…Ø«Ù„ wien.gv.at)'
        required: true
        default: 'tesla.com'

jobs:
  crawler-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Go & Python
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23'
          cache: false
        - name: Setup Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.12'
            cache: false

      - name: Install Tools (Ù…Ø¶Ù…ÙˆÙ† 100% Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡)
        run: |
          # Go tools (subfinder, httpx, katana)
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@v1.6.9
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # Waymore (pip install - Ø´ØºØ§Ù„ 100% Ù…Ù† PyPI)
          pip install waymore
          
          # Findomain binary
          curl -sLO https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip
          unzip -o findomain-linux.zip
          chmod +x findomain
          sudo mv findomain /usr/local/bin/

          # jq Ù„Ù„Ù€ JSON
          sudo apt-get update -qq
          sudo apt-get install -y jq -qq

      - name: Notify Start
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d '{
            "content": "**Crawler Scan Ø¨Ø¯Ø£ Ø¹Ù„Ù‰** `'${{ inputs.domain }}'`\nØ¬Ø§Ø±ÙŠ Ø¬Ù…Ø¹ subdomains â†’ alive â†’ katana â†’ waymore... (Ù†ØªØ§ÙŠØ¬ ÙÙŠ 60 Ø¯Ù‚ÙŠÙ‚Ø©)"
          }'

      - name: Collect Subdomains (5 Ù…ØµØ§Ø¯Ø± Ù‚ÙˆÙŠØ©)
        run: |
          DOMAIN="${{ inputs.domain }}"
          
          subfinder -d $DOMAIN -all -silent -o subdomains.txt
          assetfinder --subs-only $DOMAIN >> subdomains.txt
          findomain -t $DOMAIN -q >> subdomains.txt 2>/dev/null || true
          curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/^\*\.//' | sort -u >> subdomains.txt
          curl -s "https://dns.bufferover.run/dns?q=$DOMAIN" | jq -r '.FDNS_A[]? | split(",")[1]' 2>/dev/null | sort -u >> subdomains.txt || true
          
          sort -u subdomains.txt -o subdomains.txt
          TOTAL_SUBS=$(wc -l < subdomains.txt 2>/dev/null || echo 0)
          echo "TOTAL_SUBS=$TOTAL_SUBS" >> $GITHUB_ENV

      - name: Probe Alive Hosts
        run: |
          httpx -l subdomains.txt \
            -silent -threads 500 -timeout 15 -follow-redirects \
            -status-code -title -tech-detect \
            -o alive.txt || true
          
          cut -d' ' -f1 alive.txt | sort -u > alive-clean.txt
          ALIVE=$(wc -l < alive-clean.txt 2>/dev/null || echo 0)
          echo "ALIVE_HOSTS=$ALIVE" >> $GITHUB_ENV

      - name: Run Katana Crawler (Ø¹Ù„Ù‰ Ø§Ù„Ù€ alive hosts)
        run: |
          cat alive-clean.txt | katana -silent -c 50 -d 3 -jc -kf all -o katana-urls.txt || true
          KATANA_COUNT=$(wc -l < katana-urls.txt 2>/dev/null || echo 0)
          echo "KATANA_URLS=$KATANA_COUNT" >> $GITHUB_ENV

      - name: Run Waymore (Ø¹Ù„Ù‰ Ø§Ù„Ù€ alive hosts Ù„Ù„Ù€ archives)
        run: |
          cat alive-clean.txt | waymore -i - -o waymore-urls.txt -f waymore.txt || true
          WAYMORE_COUNT=$(wc -l < waymore-urls.txt 2>/dev/null || echo 0)
          echo "WAYMORE_URLS=$WAYMORE_COUNT" >> $GITHUB_ENV

      - name: Send Results to Discord
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d '{
            "content": "**Crawler Scan Ø®Ù„Ù‘Øµ ÙŠØ§ ÙˆØ­Ø´!**\n**Target:** `'${{ inputs.domain }}'`\n**Subdomains:** ${{ env.TOTAL_SUBS }}\n**Alive Hosts:** ${{ env.ALIVE_HOSTS }}\n**Katana URLs:** ${{ env.KATANA_URLS }}\n**Waymore URLs:** ${{ env.WAYMORE_URLS }}\n\nØ¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ 5 Ù…Ù„ÙØ§Øª Ù†Ø¶ÙŠÙØ©...",
            "embeds": [{"title": "Ù†ØªØ§ÙŠØ¬ Ø¬Ø§Ù…Ø¯Ø© ÙØ´Ø®", "color": 3066993}]
          }'
          curl -F "file=@subdomains.txt" -F "content=1. **ÙƒÙ„ Ø§Ù„ØµØ¨ Ø¯ÙˆÙ…ÙŠÙ†Ø²** (${{ env.TOTAL_SUBS }})" "$DISCORD_WEBHOOK"
          curl -F "file=@alive.txt" -F "content=2. **Ø§Ù„Ù€ Alive Ù…Ø¹ Ø¥Ù†ÙÙˆ** (${{ env.ALIVE_HOSTS }})" "$DISCORD_WEBHOOK"
          curl -F "file=@alive-clean.txt" -F "content=3. **Ø§Ù„Ù€ Alive Ø§Ù„Ù†Ø¶ÙŠÙ**" "$DISCORD_WEBHOOK"
          curl -F "file=@katana-urls.txt" -F "content=4. **Katana Crawled URLs** (${{ env.KATANA_URLS }})" "$DISCORD_WEBHOOK"
          curl -F "file=@waymore-urls.txt" -F "content=5. **Waymore Archive URLs** (${{ env.WAYMORE_URLS }})" "$DISCORD_WEBHOOK"

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CRAWLER-${{ inputs.domain }}-${{ github.run_number }}
          path: |
            subdomains.txt
            alive.txt
            alive-clean.txt
            katana-urls.txt
            waymore-urls.txt

      - name: Final Success
        run: |
          echo "âœ… Crawler Scan completed â€“ ØµÙØ± Ø£Ø®Ø·Ø§Ø¡!"
          echo "Subdomains: ${{ env.TOTAL_SUBS }} | Alive: ${{ env.ALIVE_HOSTS }} | Katana: ${{ env.KATANA_URLS }} | Waymore: ${{ env.WAYMORE_URLS }}"
          [ -n "$DISCORD_WEBHOOK" ] && curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "ØªÙ…Ø§Ù… ÙŠØ§ Ù…Ø¹Ù„Ù…ØŒ ÙƒÙ„ Ø§Ù„Ù€ URLs Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ÙƒØ³Ø±! ğŸ”¥"}'
