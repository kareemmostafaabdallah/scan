name: Katana
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain (مثل wien.gv.at)'
        required: true
        default: 'tesla.com'

jobs:
  crawler-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23'
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Tools (صفر أخطاء)
        run: |
          # Go Tools
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@v1.6.9
          go install github.com/projectdiscovery/katana/cmd/katana@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # Findomain
          curl -sLO https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip
          unzip -o findomain-linux.zip
          chmod +x findomain
          sudo mv findomain /usr/local/bin/

          # Waymore (Python)
          pip install waymore --quiet

          # jq
          sudo apt-get update -qq
          sudo apt-get install -y jq -qq

      - name: Start Notification
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d '{
            "content": "**بدأنا الكرولر على** `'${{ inputs.domain }}'`\nجاري جمع subdomains → alive → katana → waymore... (هيخلّص في ساعة تقريبًا)"
          }'

      - name: Subdomain Enumeration
        run: |
          DOMAIN="${{ inputs.domain }}"
          subfinder -d $DOMAIN -all -silent -o s1.txt
          assetfinder --subs-only $DOMAIN > s2.txt 2>/dev/null || true
          findomain -t $DOMAIN -q > s3.txt 2>/dev/null || true
          curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/^\*\.//' | sort -u > s4.txt
          cat s*.txt 2>/dev/null | sort -u | grep -E "^[a-zA-Z0-9]" > all-subdomains.txt
          echo "SUBS=$(wc -l < all-subdomains.txt)" >> $GITHUB_ENV

      - name: Probe Alive Hosts
        run: |
          httpx -l all-subdomains.txt -silent -threads 500 -timeout 15 -follow-redirects -status-code -title -o alive-full.txt || true
          cut -d' ' -f1 alive-full.txt | sort -u > alive.txt
          echo "ALIVE=$(wc -l < alive.txt)" >> $GITHUB_ENV

      - name: Katana Crawling
        run: |
          cat alive.txt | katana -silent -c 50 -d 5 -jc -o katana.txt || true
          echo "KATANA=$(wc -l < katana.txt || echo 0)" >> $GITHUB_ENV

      - name: Waymore (Archives + APIs)
        run: |
          cat alive.txt | waymore -i - -o waymore.txt || true
          echo "WAYMORE=$(wc -l < waymore.txt || echo 0)" >> $GITHUB_ENV

      - name: Send Results to Discord
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d "{
            \"content\": \"**خلّصنا يا معلم!**\n**Target:** ${{ inputs.domain }}\n**Subdomains:** ${{ env.SUBS }}\n**Alive:** ${{ env.ALIVE }}\n**Katana URLs:** ${{ env.KATANA }}\n**Waymore URLs:** ${{ env.WAYMORE }}\"
          }"
          curl -F "file=@all-subdomains.txt" -F "content=1. كل الصب دومينز" "$DISCORD_WEBHOOK"
          curl -F "file=@alive-full.txt"   -F "content=2. Alive مع إنفو" "$DISCORD_WEBHOOK"
          curl -F "file=@alive.txt"        -F "content=3. Alive نضيف" "$DISCORD_WEBHOOK"
          curl -F "file=@katana.txt"       -F "content=4. Katana URLs" "$DISCORD_WEBHOOK"
          curl -F "file=@waymore.txt"      -F "content=5. Waymore URLs" "$DISCORD_WEBHOOK"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: RECON-${{ inputs.domain }}-${{ github.run_number }}
          path: |
            all-subdomains.txt
            alive-full.txt
            alive.txt
            katana.txt
            waymore.txt

      - name: Done
        run: |
          [ -n "$DISCORD_WEBHOOK" ] && curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "تمام التمام يا بطل – كل الـ URLs عندك دلوقتي!"}'
