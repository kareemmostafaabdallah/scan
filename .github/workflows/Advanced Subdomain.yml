name: Advanced Subdomain

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªÙØ­ØµÙ‡ (Ù…Ø«Ù„: target.com)'
        required: true
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      # â”€â”€â”€â”€â”€â”€ 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ù€ Secret â”€â”€â”€â”€â”€â”€
      - name: Domain Authorization Check
        run: |
          ALLOWED="${{ secrets.ALLOWED_DOMAINS }}"

          if [[ -z "$ALLOWED" ]]; then
            echo "âŒ Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ secret Ø§Ø³Ù…Ù‡ ALLOWED_DOMAINS ÙÙŠ Ø§Ù„Ù€ Settings"
            exit 1
          fi

          DOMAIN="${{ inputs.domain }}"
          if echo "$DOMAIN" | grep -E "^($ALLOWED)$" >/dev/null; then
            echo "âœ… Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø³Ù…ÙˆØ­: $DOMAIN"
            echo "TARGET=$DOMAIN" >> $GITHUB_ENV
          else
            echo "ğŸš« Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ† '$DOMAIN' ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­!"
            echo "Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø­Ø§Ù„ÙŠÙ‹Ø§: $ALLOWED"
            exit 1
          fi

      # â”€â”€â”€â”€â”€â”€ 2. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø£Ø¯ÙˆØ§Øª â”€â”€â”€â”€â”€â”€
      - name: Install Tools
        run: |
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          sudo apt-get update -qq && sudo apt-get install -y jq

      - name: Update Nuclei Templates
        run: nuclei -update-templates -silent

      # â”€â”€â”€â”€â”€â”€ 3. Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ â”€â”€â”€â”€â”€â”€
      - name: Discord â†’ Scan Started
        run: |
          curl -X POST -H "Content-Type: application/json" "${{ secrets.DISCORD_WEBHOOK }}" -d '{
            "embeds": [{
              "title": "Ø¨Ø¯Ø¡ Ø³ÙƒØ§Ù† Ø£Ù…Ù†ÙŠ Ø¬Ø¯ÙŠØ¯",
              "description": "**Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†:** `'${{ env.TARGET }}'`\n**Ø¨ÙˆØ§Ø³Ø·Ø©:** ${{ github.actor }}\n**ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡:** <t:$(date +%s):F>",
              "color": 3447003,
              "thumbnail": { "url": "https://i.imgur.com/8YghQ.jpg" }
            }]
          }'

      # â”€â”€â”€â”€â”€â”€ 4. Subfinder â”€â”€â”€â”€â”€â”€
      - name: Subfinder Enumeration
        run: |
          subfinder -d ${{ env.TARGET }} -all -silent -o subdomains_raw.txt
          sort -u subdomains_raw.txt -o subdomains.txt
          echo "SUBDOMAINS=$(wc -l < subdomains.txt)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€ 5. HTTPX â†’ Ø§Ù„Ø­ÙŠØ© Ø¨Ø³ â”€â”€â”€â”€â”€â”€
      - name: Probe Live Hosts
        run: |
          httpx -l subdomains.txt -silent -threads 300 -timeout 10 -o alive.txt
          echo "ALIVE=$(wc -l < alive.txt || echo 0)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€ 6. Nuclei Ø³ÙƒØ§Ù† Ø´Ø§Ù…Ù„ â”€â”€â”€â”€â”€â”€
      - name: Nuclei Scan
        run: |
          nuclei -l alive.txt -severity critical,high,medium,low -concurrency 70 -c 150 -silent -jsonl -o nuclei.jsonl
          cat nuclei.jsonl | jq -r '[.info.severity | ascii_upcase] .template-id + " â†’ " + .matched-at' > nuclei.txt 2>/dev/null || true
          echo "VULNS=$(wc -l < nuclei.txt || echo 0)" >> $GITHUB_ENV

      # â”€â”€â”€â”€â”€â”€ 7. ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ø®Øµ Ø¹Ù„Ù‰ Ø¯ÙŠØ³ÙƒÙˆØ±Ø¯ â”€â”€â”€â”€â”€â”€
      - name: Discord â†’ Summary Report
        run: |
          CRITICAL=$(grep -ic "CRITICAL" nuclei.txt || echo 0)
          HIGH=$(grep -ic "HIGH" nuclei.txt || echo 0)
          MEDIUM=$(grep -ic "MEDIUM" nuclei.txt || echo 0)
          LOW=$(grep -ic "LOW" nuclei.txt || echo 0)

          if [ $CRITICAL -gt 0 ]; then COLOR=15158332
          elif [ $HIGH -gt 0 ]; then COLOR=15105570
          elif [ $MEDIUM -gt 0 ]; then COLOR=16763904
          else COLOR=3066993; fi

          curl -X POST -H "Content-Type: application/json" "${{ secrets.DISCORD_WEBHOOK }}" -d @- << EOF
          {
            "embeds": [{
              "title": "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø³ÙƒØ§Ù† Ø¨Ù†Ø¬Ø§Ø­",
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "description": "**Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†:** \`${{ env.TARGET }}\`\n**Ø§Ù„Ø³Ø§Ø¨Ø¯ÙˆÙ…ÙŠÙ†Ø² Ø§Ù„ÙƒÙ„ÙŠØ©:** ${{ env.SUBDOMAINS }}\n**Ø§Ù„Ø­ÙŠØ©:** ${{ env.ALIVE }}\n**Ø§Ù„Ø«ØºØ±Ø§Øª:** ${{ env.VULNS }}",
              "color": $COLOR,
              "fields": [
                {"name": "Critical", "value": "$CRITICAL", "inline": true},
                {"name": "High", "value": "$HIGH", "inline": true},
                {"name": "Medium", "value": "$MEDIUM", "inline": true},
                {"name": "Low", "value": "$LOW", "inline": true}
              ],
              "footer": {"text": "Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù€ Run ÙƒØ§Ù…Ù„"},
              "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }]
          }
          EOF

      # â”€â”€â”€â”€â”€â”€ 8. Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø«ØºØ±Ø© ÙÙŠ Ø¥Ù…Ø¨Ø¯ Ù…Ù†ÙØµÙ„ (Ø¬Ø§Ù…Ø¯ Ø¬Ø¯Ù‹Ø§) â”€â”€â”€â”€â”€â”€
      - name: Discord â†’ Individual Vulnerabilities
        if: env.VULNS > 0
        run: |
          cat nuclei.jsonl | jq -r '
            . as $raw |
            ($raw.info.severity | ascii_upcase) as $sev |
            (if $sev == "CRITICAL" then 15158332
             elif $sev == "HIGH" then 15105570
             elif $sev == "MEDIUM" then 16763904
             elif $sev == "LOW" then 3447003
             else 10181046 end) as $color |
            {
              embeds: [{
                title: $raw.template-id,
                description: "**Severity:** `" + $sev + "`\n**Host:** `" + $raw.matched-at + "`\n**Name:** " + $raw.info.name,
                color: $color,
                fields: [
                  { name: "Extracted", value: ($raw.extracted-results // ["-"] |.[0] // "-"), inline: false },
                  { name: "Matcher", value: ($raw.matcher-name // "N/A"), inline: true }
                ],
                footer: { text: "Nuclei â€¢ " + ($raw.info.author // "ProjectDiscovery") },
                timestamp: $raw.timestamp
              }]
            } | @json
          ' | while read payload; do
            curl -X POST -H "Content-Type: application/json" "${{ secrets.DISCORD_WEBHOOK }}" -d "$payload"
            sleep 1.5
          done

      # â”€â”€â”€â”€â”€â”€ 9. Ø±ÙØ¹ Ø§Ù„Ù†ØªØ§ÙŠØ¬ â”€â”€â”€â”€â”€â”€
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "scan-${{ env.TARGET }}-${{ github.run_id }}"
          path: |
            subdomains.txt
            alive.txt
            nuclei.txt
            nuclei.jsonl
          retention-days: 14
