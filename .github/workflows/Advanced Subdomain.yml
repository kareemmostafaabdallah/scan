name: Advanced Subdomain
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1' # كل إثنين 6 الصبح (ممكن تلغيه لو عايز)

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install Tools (أحدث إصدارات 2025)
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          sudo apt-get update -qq && sudo apt-get install -y jq awscli -y

      - name: Validate Secrets
        run: |
          [ -z "${{ secrets.DISCORD_WEBHOOK }}" ] && echo "DISCORD_WEBHOOK missing!" && exit 1
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV

      - name: Set Domain
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DOMAIN=${{ inputs.domain }}" >> $GITHUB_ENV
          else
            echo "DOMAIN=example.com" >> $GITHUB_ENV
          fi

      - name: Notify Start
        run: |
          curl -s -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{
            "content": "بدأ السكان\n**Domain:** `${{ env.DOMAIN }}`\n**Trigger:** ${{ github.event_name }}\n**Runner:** GitHub Actions"
          }'

      # ────── الفحص الجديد الجامد جدًا (2025) ──────
      - name: Aggressive Subdomain Enumeration
        run: |
          subfinder -d ${{ env.DOMAIN }} -all -recursive -silent -o subfinder.txt
          echo "Subfinder: $(wc -l < subfinder.txt) subdomains"

          # إضافة مصادر قوية جدًا
          curl -s "https://chaos.projectdiscovery.io/${{ env.DOMAIN }}" | jq -r '.[].subdomain]' >> chaos.txt || true
          curl -s "https://crt.sh/?q=%25.${{ env.DOMAIN }}&output=json" | jq -r '.[].name_value' | sed 's/\*\.//g' | sort -u >> crtsh.txt || true

          cat subfinder.txt chaos.txt crtsh.txt 2>/dev/null | sort -u -o all_subs.txt
          echo "Total raw subdomains: $(wc -l < all_subs.txt)"

      - name: Probe Live + Title + Tech + Status
        run: |
          httpx -l all_subs.txt -silent -title -tech-detect -status-code -threads 300 -timeout 15 -o alive.txt
          echo "ALIVE=$(wc -l < alive.txt)" >> $GITHUB_ENV

      - name: Fast Port Scan (Top 1000 + web ports)
        run: |
          cat alive.txt | cut -d' ' -f1 | naabu -top-ports 1000 -exclude-ports 80,443 -silent -o ports.txt
          cat alive.txt ports.txt | sort -u -o final_targets.txt
          echo "FINAL_TARGETS=$(wc -l < final_targets.txt)" >> $GITHUB_ENV

      - name: Update Nuclei Templates + Aggressive Scan
        run: |
          nuclei -update-templates -silent
          nuclei -l final_targets.txt -severity critical,high,medium -es info -concurrency 100 -bulk-size 50 -rate-limit 150 -retries 3 -jsonl -o nuclei.jsonl -silent
          cat nuclei.jsonl | jq -r '[.info.severity] .template-id + " → " + .host + " [" + (.info.name // "No name") + "]"' > nuclei.txt 2>/dev/null || true
          echo "VULNS=$(wc -l < nuclei.txt || echo 0)" >> $GITHUB_ENV

      # ────── نفس الإشعارات القديمة اللي بتحبها بس محسنة شوية ──────
      - name: Notify Subdomains Summary
        run: |
          ALIVE_COUNT=$(wc -l < alive.txt || echo 0)
          MESSAGE="**Subfinder + Chaos + crt.sh Complete**\n**Domain:** ${{ env.DOMAIN }}\n**Total Found:** $(wc -l < all_subs.txt)\n**Live Hosts:** $ALIVE_COUNT\n\`\`\`\n$(head -20 alive.txt)\n\`\`\`"
          [ $(wc -l < all_subs.txt) -gt 20 ] && MESSAGE="${MESSAGE}\n... والباقي في الآرتيفاكتس"
          curl -s -X POST "${{ env.DISCORD_WEBHOOK }}" -d "{\"content\": $(echo "$MESSAGE" | jq -R .)}"

      - name: Notify Vulnerabilities Summary
        run: |
          if [ ${{ env.VULNS }} -eq 0 ]; then
            curl -s -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{"content": "**Nuclei Complete**\n**Domain:** `${{ env.DOMAIN }}`\nلا توجد ثغرات Critical/High/Medium"}'
          else
            curl -s -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{"content": "**تم اكتشاف ${{ env.VULNS }} ثغرة خطيرة!**\n**Domain:** `${{ env.DOMAIN }}`\nجاري إرسال التفاصيل..."}'
          fi

      - name: Send Each Vulnerability Separately
        if: env.VULNS > 0
        run: |
          while IFS= read -r line; do
            curl -s -X POST "${{ env.DISCORD_WEBHOOK }}" -d "{\"content\": \"**Vulnerability**\n\`\`\`\n$line\n\`\`\`\"}"
            sleep 1
          done < nuclei.txt

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ env.DOMAIN }}
          path: |
            all_subs.txt
            alive.txt
            nuclei.jsonl
            nuclei.txt
