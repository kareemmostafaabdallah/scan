name: Advanced Subdomain
on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1' # كل إثنين 6 الصبح (إلغيه لو مش عايزه)

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq > /dev/null

          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

      - name: Validate Discord Webhook
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "DISCORD_WEBHOOK secret missing!"
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV

      - name: Set Domain
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DOMAIN=${{ inputs.domain }}" >> $GITHUB_ENV
          else
            echo "DOMAIN=example.com" >> $GITHUB_ENV
          fi

      # 1. إشعار البداية
      - name: Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" "${{ env.DISCORD_WEBHOOK }}" -d '{
            "content": "**بدء السكان**\n**Domain:** `'${{ env.DOMAIN }}'`\n**Trigger:** ${{ github.event_name }}\n**Time:** <t:$(date +%s):F>"
          }'

      # 2. فحص السابدومينز الجامد (Subfinder + Chaos + crt.sh)
      - name: Ultimate Subdomain Enumeration
        run: |
          subfinder -d ${{ env.DOMAIN }} -all -silent -o subfinder.txt

          curl -s "https://chaos.projectdiscovery.io/?q=${{ env.DOMAIN }}" | jq -r '.[].subdomain' 2>/dev/null >> chaos.txt || true
          curl -s "https://crt.sh/?q=%.${{ env.DOMAIN }}&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/\*\.//g' | tr '[:upper:]' '[:lower:]' >> crtsh.txt || true

          cat subfinder.txt chaos.txt crtsh.txt 2>/dev/null | sort -u -o all_subdomains.txt
          echo "SUBDOMAINS=$(wc -l < all_subdomains.txt)" >> $GITHUB_ENV

      # 3. فحص الحية + عنوان + تقنيات
      - name: Probe Live Hosts
        run: |
          httpx -l all_subdomains.txt -silent -title -status-code -tech-detect -threads 400 -timeout 12 -o alive.txt
          echo "ALIVE=$(wc -l < alive.txt || echo 0)" >> $GITHUB_ENV

      # 4. Nuclei بدون أي تحذير
      - name: Update & Run Nuclei
        run: |
          nuclei -update-templates -silent
          nuclei -l alive.txt -severity critical,high,medium -es info -auto -rate-limit 200 -retries 2 -jsonl -o nuclei.jsonl -silent
          cat nuclei.jsonl | jq -r '[.info.severity | ascii_upcase] .template-id + " → " + .matched-at + " [" + (.info.name // "No name") + "]"' > nuclei.txt 2>/dev/null || echo "" > nuclei.txt
          echo "VULNS=$(wc -l < nuclei.txt || echo 0)" >> $GITHUB_ENV

      # 5. إشعار السابدومينز الحية
      - name: Notify Subdomains Results
        run: |
          SAMPLE=$(head -30 alive.txt | cut -d' ' -f1 | sed 's/^/• /')
          MESSAGE="**تم العثور على سابدومينز حية**\n**Domain:** ${{ env.DOMAIN }}\n**الكل:** ${{ env.SUBDOMAINS }} | **الحية:** ${{ env.ALIVE }}\n\`\`\`\n$SAMPLE"
          if [ ${{ env.ALIVE }} -gt 30 ]; then
            MESSAGE="$MESSAGE\n... و $((${env.ALIVE}-30)) تانيين في الآرتيفاكتس"
          fi
          MESSAGE="$MESSAGE\n\`\`\`"
          curl -X POST -H "Content-Type: application/json" "${{ env.DISCORD_WEBHOOK }}" -d "{\"content\": \"$MESSAGE\"}"

      # 6. ملخص الثغرات
      - name: Notify Nuclei Summary
        run: |
          if [ ${{ env.VULNS }} -eq 0 ]; then
            curl -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{
              "content": "**Nuclei Complete**\n**Domain:** `'${{ env.DOMAIN }}'`\nلا توجد ثغرات Critical/High/Medium"
            }'
          else
            curl -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{
              "content": "**تم اكتشاف ${{ env.VULNS }} ثغرة خطيرة!**\n**Domain:** `'${{ env.DOMAIN }}'`\nجاري إرسال التفاصيل..."
            }'
          fi

      # 7. كل ثغرة في رسالة منفصلة
      - name: Send Each Vulnerability
        if: env.VULNS > 0
        run: |
          while IFS= read -r vuln; do
            curl -X POST -H "Content-Type: application/json" "${{ env.DISCORD_WEBHOOK }}" -d "{\"content\": \"**ثغرة مكتشفة**\n\`\`\`\n$vuln\n\`\`\`\"}"
            sleep 1.2
          done < nuclei.txt

      # 8. رسالة النهاية + رابط الـ Run
      - name: Final Summary
        run: |
          curl -X POST "${{ env.DISCORD_WEBHOOK }}" -d '{
            "content": "**السكان انتهى تمامًا**\n**Domain:** `'${{ env.DOMAIN }}'`\n**Live Hosts:** ${{ env.ALIVE }}\n**Vulnerabilities:** ${{ env.VULNS }}\nرابط الـ Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }'

      # 9. رفع النتايج
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: "scan-${{ env.DOMAIN }}-${{ github.run_id }}"
          path: |
            all_subdomains.txt
            alive.txt
            nuclei.jsonl
            nuclei.txt
          retention-days: 10
