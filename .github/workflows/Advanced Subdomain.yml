name: Advanced Subdomain.

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain'
        required: true
        default: 'example.com'

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}   # ← الحل السحري

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'
          cache: true

      - name: Install Tools
        run: |
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install -v github.com/tomnomnom/assetfinder@latest
          
          echo "$HOME/go/bin" >> $GITHUB_PATH
          
          curl -sLO https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip
          unzip -o findomain-linux.zip && chmod +x findomain && sudo mv findomain /usr/local/bin/
          sudo apt-get update -qq && sudo apt-get install -y jq

      # ← الـ validation دلوقتي شغال 100% لأن الـ env معبي
      - name: Validate Discord Webhook
        run: |
          if [ -z "$DISCORD_WEBHOOK" ] || [ "$DISCORD_WEBHOOK" = "***" ]; then
            echo "DISCORD_WEBHOOK is missing or hidden!"
            exit 1
          else
            echo "Discord webhook is ready!"
          fi

      - name: Set Target
        run: |
          echo "TARGET=${{ inputs.domain }}" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d '{
            "embeds": [{"title": "Scan Started", "description": "**Target:** `'${{ inputs.domain }}'`", "color": 16745728}]
          }'

      # باقي الـ workflow زي ما هو (recon → httpx → nuclei → send results)
      # أحط الباقي كله هنا عشان تبقى نسخة كاملة وتشتغل من أول مرة

      - name: Ultimate Recon
        run: |
          subfinder -d ${{ inputs.domain }} -all -recursive -silent -o s1.txt
          assetfinder --subs-only ${{ inputs.domain }} > s2.txt
          findomain -t ${{ inputs.domain }} -q > s3.txt
          curl -s "https://crt.sh/?q=%25.${{ inputs.domain }}&output=json" | jq -r '.[].name_value' | sort -u > s4.txt
          
          cat s*.txt | sort -u | grep -v '*' > all-subdomains.txt
          echo "TOTAL=$(wc -l < all-subdomains.txt)" >> $GITHUB_ENV

      - name: Probe Alive
        run: |
          httpx -l all-subdomains.txt -silent -threads 500 -timeout 20 -follow-redirects -o alive.txt
          echo "ALIVE=$(wc -l < alive.txt || echo 0)" >> $GITHUB_ENV

      - name: Update Nuclei Templates
        run: nuclei -update-templates -silent

      - name: Run Nuclei
        run: |
          nuclei -l alive.txt -severity critical,high,medium,low,info \
            -c 40 -bulk-size 20 -rate-limit 80 -retries 5 -timeout 20 \
            -jsonl -o nuclei.jsonl -silent || true
          
          [ ! -f nuclei.jsonl ] && touch nuclei.jsonl
          echo "VULNS=$(wc -l < nuclei.jsonl)" >> $GITHUB_ENV

      - name: Send Results
        run: |
          if [ ${{ env.VULNS }} -gt 0 ]; then
            jq -c . nuclei.jsonl | while read v; do
              sev=$(echo "$v" | jq -r '.info.severity // "info"')
              name=$(echo "$v" | jq -r '.info.name')
              url=$(echo "$v" | jq -r '."matched-at" // .host')
              color=10181046
              [[ $sev == "critical" ]] && color=15158332
              [[ $sev == "high" ]] && color=15105570
              [[ $sev == "medium" ]] && color=16763904

              curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d "{
                \"embeds\": [{
                  \"title\": \"$name\",
                  \"description\": \"\`$url\`\",
                  \"color\": $color,
                  \"fields\": [{\"name\": \"Severity\", \"value\": \"${sev^}\"}]
                }]
              }"
              sleep 1.2
            done
          else
            curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "Clean! No vulnerabilities found"}'
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.domain }}-$(date +%Y%m%d-%H%M%S)
          path: |
            all-subdomains.txt
            alive.txt
            nuclei.jsonl

      - name: Final Notify
        run: |
          curl -X POST "$DISCORD_WEBHOOK" -d '{
            "embeds": [{"title": "Scan Finished", "description": "**Target:** ${{ inputs.domain }}\n**Vulns:** ${{ env.VULNS }}\nCheck artifacts!", "color": 5793266}]
          }'
