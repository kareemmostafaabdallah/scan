name: Full Asset Discovery, Vulnerability Scan & Fuzz (amass active + ffuf)

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan (e.g. example.com)'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1'  # weekly on Monday 06:00 UTC

env:
  GOPATH: /home/runner/go
  GOBIN: /home/runner/go/bin

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Prepare Go environment
        run: |
          mkdir -p "${GOBIN}"
          echo "${GOBIN}" >> $GITHUB_PATH
          echo "Go environment prepared in ${GOBIN}"

      - name: Install Tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl unzip python3-pip git
          GO111MODULE=on go install -v github.com/OWASP/Amass/v3/...@latest
          GO111MODULE=on go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          GO111MODULE=on go install -v github.com/tomnomnom/assetfinder@latest
          GO111MODULE=on go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          GO111MODULE=on go install -v github.com/projectdiscovery/naabu/v2/cmd/naabu@latest
          GO111MODULE=on go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          GO111MODULE=on go install -v github.com/ffuf/ffuf@latest
          echo "Tools installed in ${GOBIN}"
          ls -1 "${GOBIN}" || true

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "::error::DISCORD_WEBHOOK secret is not set"
            exit 1
          fi
          if [ "${{ secrets.SCAN_AUTH }}" != "AUTHORIZED" ]; then
            echo "::error::You must set SCAN_AUTH=AUTHORIZED in repo secrets before running."
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV
          echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV

      - name: Notify Start (Legal Warning)
        run: |
          MSG="ðŸ” **Scan Started** for domain: $DOMAIN\nâš ï¸ *Active reconnaissance & fuzzing ahead (requires authorization)*"
          curl -s -X POST -H "Content-Type: application/json" \
          -d "$(jq -n --arg msg "$MSG" '{content: $msg}')" "${{ env.DISCORD_WEBHOOK }}"

      - name: Gather Subdomains & URLs
        run: |
          mkdir -p scripts tmp
          cat > scripts/gather_subs_and_urls.sh <<'EOF'
#!/usr/bin/env bash
set -euo pipefail
DOMAIN="$1"
OUT_SUBS="$2"
OUT_URLS="$3"
mkdir -p "$(dirname "$OUT_SUBS")"
> "$OUT_SUBS"
> "$OUT_URLS"

echo "[*] Running passive enumeration..."
amass enum -passive -d "$DOMAIN" -o amass_passive.txt || true
subfinder -d "$DOMAIN" -silent -o subfinder.txt || true
assetfinder --subs-only "$DOMAIN" > assetfinder.txt || true
curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/\*\.//g' > crtsh.txt || true

cat amass_passive.txt subfinder.txt assetfinder.txt crtsh.txt | grep "$DOMAIN" | sort -u > "$OUT_SUBS"

echo "[*] Running active amass (noisy)..."
amass enum -active -d "$DOMAIN" -min-for-recursive 2 -o amass_active.txt || true
cat amass_active.txt >> "$OUT_SUBS"
sort -u "$OUT_SUBS" -o "$OUT_SUBS"

echo "[*] Gathering historical URLs..."
if command -v gau >/dev/null 2>&1; then
  gau "$DOMAIN" > "$OUT_URLS" || true
fi
EOF
          bash scripts/gather_subs_and_urls.sh "$DOMAIN" tmp/subdomains.txt tmp/urls.txt

      - name: Check Alive Hosts
        run: |
          cat tmp/subdomains.txt | httpx -silent -o tmp/alive.txt
          echo "ALIVE_COUNT=$(wc -l < tmp/alive.txt)" >> $GITHUB_ENV

      - name: Run Nuclei
        run: |
          nuclei -ut
          nuclei -l tmp/alive.txt -severity critical,high,medium -o tmp/nuclei.txt
          echo "NUCLEI_COUNT=$(wc -l < tmp/nuclei.txt)" >> $GITHUB_ENV

      - name: FFUF Sensitive Fuzz
        run: |
          mkdir -p tmp/ffuf
          echo "[*] Extracting sensitive endpoints..."
          grep -E '/(login|admin|dashboard|auth|api|oauth)' tmp/urls.txt | sort -u > tmp/sensitive.txt || true
          echo "[*] Running ffuf fuzzing..."
          while read -r url; do
            safe=$(echo "$url" | sed 's#[^a-zA-Z0-9]#_#g')
            ffuf -u "${url%/}/FUZZ" -w /usr/share/wordlists/dirb/common.txt -mc 200,301,302,403 -t 30 -o "tmp/ffuf/$safe.json" -of json || true
          done < tmp/sensitive.txt

      - name: Discord Summary
        run: |
          MSG="ðŸ“Š **Scan Summary** for $DOMAIN\nAlive Hosts: ${{ env.ALIVE_COUNT }}\nVulnerabilities: ${{ env.NUCLEI_COUNT }}\nFFUF Results: $(ls tmp/ffuf | wc -l)"
          curl -s -X POST -H "Content-Type: application/json" \
          -d "$(jq -n --arg msg "$MSG" '{content: $msg}')" "${{ env.DISCORD_WEBHOOK }}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results
          path: tmp/
