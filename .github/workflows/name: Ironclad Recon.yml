name: Ironclad Recon

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Target domain (Ù…Ø«Ù„ wien.gv.at)'
        required: true
        default: 'tesla.com'

jobs:
  ironclad:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        continue-on-error: true

      - name: Setup Go (Clean)
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23'
          cache: false  # ØµÙØ± warnings

      - name: Install Stable Tools (go install only â€“ ØµÙØ± errors)
        run: |
          # Ø£Ø¯ÙˆØ§Øª Ù…Ø«Ø¨ØªØ© Ø¨Ù€ go install (Ø´ØºØ§Ù„Ø© 100% Ø¨Ø¯ÙˆÙ† modules Ù…Ø´Ø§ÙƒÙ„)
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@v1.6.9
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          go install github.com/tomnomnom/assetfinder@latest
          
          # PATH
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # Findomain binary (download Ù…Ø¨Ø§Ø´Ø±ØŒ Ø¨Ø¯ÙˆÙ† go)
          curl -sLO https://github.com/Findomain/Findomain/releases/latest/download/findomain-linux.zip
          unzip -o findomain-linux.zip
          chmod +x findomain
          sudo mv findomain /usr/local/bin/

          # jq
          sudo apt-get update -qq
          sudo apt-get install -y jq -qq

      - name: Notify Start
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d '{
            "content": "**Ironclad Recon Ø¨Ø¯Ø£ Ø¹Ù„Ù‰** `'${{ inputs.domain }}'`\nØ¬Ø§Ø±ÙŠ Ø¬Ù…Ø¹ Ø§Ù„ØµØ¨ Ø¯ÙˆÙ…ÙŠÙ†Ø² + scan... (Ù…Ø¶Ù…ÙˆÙ† Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡)"
          }'

      - name: Collect Subdomains (5 Ù…ØµØ§Ø¯Ø± Ù‚ÙˆÙŠØ© ÙˆÙ…Ø³ØªÙ‚Ø±Ø©)
        run: |
          DOMAIN="${{ inputs.domain }}"
          
          # Subfinder (Ø§Ù„Ø£Ø³Ø§Ø³)
          subfinder -d $DOMAIN -all -silent -o subfinder.txt
          
          # Assetfinder
          assetfinder --subs-only $DOMAIN > assetfinder.txt
          
          # Findomain
          findomain -t $DOMAIN -q > findomain.txt 2>/dev/null || true
          
          # crt.sh
          curl -s "https://crt.sh/?q=%25.$DOMAIN&output=json" | jq -r '.[].name_value' 2>/dev/null | sed 's/^\*\.//' | sort -u > crtsh.txt
          
          # BufferOver
          curl -s "https://dns.bufferover.run/dns?q=$DOMAIN" | jq -r '.FDNS_A[]? | split(",")[1]' 2>/dev/null | sort -u > bufferover.txt || true
          
          # Ø¬Ù…Ø¹ ÙˆØªÙ†Ø¸ÙŠÙ
          cat *.txt 2>/dev/null | sort -u | grep "\.$DOMAIN$" | grep -v '*' > all-subdomains.txt
          TOTAL=$(wc -l < all-subdomains.txt 2>/dev/null || echo 0)
          echo "TOTAL_SUBS=$TOTAL" >> $GITHUB_ENV

      - name: Probe Alive
        run: |
          httpx -l all-subdomains.txt \
            -silent -threads 400 -timeout 15 -follow-redirects \
            -status-code -title -tech-detect \
            -o alive-full.txt || true
          
          cut -d' ' -f1 alive-full.txt | sort -u > alive-clean.txt
          ALIVE=$(wc -l < alive-clean.txt 2>/dev/null || echo 0)
          echo "ALIVE_HOSTS=$ALIVE" >> $GITHUB_ENV

      - name: Quick Nuclei Scan (High-Impact Only)
        run: |
          nuclei -update-templates -silent
          nuclei -l alive-clean.txt \
            -tags cve,misconfig,exposure,default-login \
            -severity critical,high \
            -c 50 -rl 100 \
            -jsonl -o vulns.jsonl -silent || true
          
          VULNS=$(wc -l < vulns.jsonl 2>/dev/null || echo 0)
          echo "VULN_COUNT=$VULNS" >> $GITHUB_ENV

      - name: Send Results to Discord
        if: env.DISCORD_WEBHOOK != ''
        run: |
          curl -X POST -H "Content-Type: application/json" "$DISCORD_WEBHOOK" -d '{
            "content": "**Ironclad Ø®Ù„Ù‘Øµ ÙŠØ§ Ø¨ÙŠÙ‡!**\n**Target:** `'${{ inputs.domain }}'`\n**Subdomains:** ${{ env.TOTAL_SUBS }}\n**Alive:** ${{ env.ALIVE_HOSTS }}\n**Vulns:** ${{ env.VULN_COUNT }}\n\nØ¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª...",
            "embeds": [{"title": "Ù†ØªØ§ÙŠØ¬ Ø¬Ø§Ù…Ø¯Ø©", "color": 3066993}]
          }'
          curl -F "file=@all-subdomains.txt" -F "content=1. ÙƒÙ„ Ø§Ù„ØµØ¨ Ø¯ÙˆÙ…ÙŠÙ†Ø² (${{ env.TOTAL_SUBS }})" "$DISCORD_WEBHOOK"
          curl -F "file=@alive-full.txt" -F "content=2. Ø§Ù„Ø¹Ø§ÙŠØ´ÙŠÙ† Ù…Ø¹ Ø¥Ù†ÙÙˆ (${{ env.ALIVE_HOSTS }})" "$DISCORD_WEBHOOK"
          curl -F "file=@alive-clean.txt" -F "content=3. Ø§Ù„Ù†Ø¶ÙŠÙ Ù„Ù„Ù€ Nuclei" "$DISCORD_WEBHOOK"
          [ -s vulns.jsonl ] && curl -F "file=@vulns.jsonl" -F "content=4. Ø§Ù„Ù€ Vulns (${{ env.VULN_COUNT }})" "$DISCORD_WEBHOOK" || echo "No vulns file"

      - name: Upload Artifacts (Ø¯Ø§ÙŠÙ…Ù‹Ø§)
        uses: actions/upload-artifact@v4
        with:
          name: IRONCLAD-${{ inputs.domain }}-${{ github.run_number }}
          path: |
            all-subdomains.txt
            alive-full.txt
            alive-clean.txt
            vulns.jsonl

      - name: Final Success
        run: |
          echo "âœ… Ironclad Recon completed â€“ ØµÙØ± Ø£Ø®Ø·Ø§Ø¡!"
          echo "Subdomains: ${{ env.TOTAL_SUBS }} | Alive: ${{ env.ALIVE_HOSTS }} | Vulns: ${{ env.VULN_COUNT }}"
          [ -n "$DISCORD_WEBHOOK" ] && curl -X POST "$DISCORD_WEBHOOK" -d '{"content": "ØªÙ…Ø§Ù… Ø§Ù„ØªÙ…Ø§Ù…ØŒ Ø§Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡ ÙˆØ§Ù†Ø³Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ! ğŸ”¥"}'
