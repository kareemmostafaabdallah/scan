name: test

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan'
        required: true
        default: 'example.com'
  schedule:
    - cron: '0 6 * * 1'  # Every Monday at 6 AM UTC

permissions:
  contents: read
  actions: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq python3 python3-pip git

      - name: Install Tools (Subfinder, Nuclei, HTTPX)
        run: |
          set -e
          echo "Installing subfinder..."
          go install -v github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          echo "Installing nuclei..."
          go install -v github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest
          echo "Installing httpx..."
          go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
          echo "Adding GOPATH/bin to PATH"
          echo "${{ runner.tool_cache }}/go/bin:$HOME/go/bin" >> $GITHUB_PATH || true
          # Ensure PATH also contains $HOME/go/bin for runner images
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Install Waymore (Python)
        run: |
          set -e
          pip3 install --no-cache-dir git+https://github.com/xnl-h4ck3r/waymore.git

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "::error::DISCORD_WEBHOOK secret is not set"
            exit 1
          fi
          echo "DISCORD_WEBHOOK=${{ secrets.DISCORD_WEBHOOK }}" >> $GITHUB_ENV

      - name: Set Domain & Timestamp
        id: set_domain
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "DOMAIN=${{ github.event.inputs.domain }}" >> $GITHUB_ENV
          else
            echo "DOMAIN=example.com" >> $GITHUB_ENV
          fi
          TIMESTAMP=$(date +'%Y-%m-%d_%H-%M-%S')
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "WORK_PREFIX=${{ env.DOMAIN }}_$TIMESTAMP" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          MESSAGE="ðŸ” **Scan Started**\n**Domain:** ${{ env.DOMAIN }}\n**Trigger:** ${{ github.event_name }}\n**Tools:** Subfinder + HTTPX + Waymore + Nuclei\n**Run ID:** ${{ env.WORK_PREFIX }}"
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
            "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Run Subfinder
        run: |
          set -e
          SUB_FILE="subdomains_${{ env.WORK_PREFIX }}.txt"
          echo "Running subfinder for ${{ env.DOMAIN }} -> $SUB_FILE"
          subfinder -d "${{ env.DOMAIN }}" -silent -o "$SUB_FILE" || { echo "::error::subfinder failed"; exit 1; }
          echo "SUBDOMAINS_FILE=$SUB_FILE" >> $GITHUB_ENV
          SUBCOUNT=$(wc -l < "$SUB_FILE" || echo 0)
          echo "SUBDOMAINS_FOUND=$SUBCOUNT" >> $GITHUB_ENV

      - name: Run HTTPX (filter live subdomains)
        run: |
          set -e
          SUB_FILE="${{ env.SUBDOMAINS_FILE }}"
          LIVE_FILE="live-subdomains_${{ env.WORK_PREFIX }}.txt"
          if [ ! -s "$SUB_FILE" ]; then
            echo "No subdomains found, creating empty live file"
            touch "$LIVE_FILE"
          else
            echo "Checking live hosts with httpx..."
            httpx -l "$SUB_FILE" -silent -status-code -o "$LIVE_FILE" || true
            # httpx output may contain status codes; keep only hostnames/urls
            # Keep unique hosts/URLs
            sort -u "$LIVE_FILE" -o "$LIVE_FILE"
          fi
          echo "LIVE_SUBDOMAINS_FILE=$LIVE_FILE" >> $GITHUB_ENV
          LIVECOUNT=$(wc -l < "$LIVE_FILE" || echo 0)
          echo "LIVE_SUBDOMAINS_FOUND=$LIVECOUNT" >> $GITHUB_ENV

      - name: Notify Subfinder + HTTPX Results
        run: |
          SUBS=$(head -c 1800 "${{ env.SUBDOMAINS_FILE }}" || echo "")
          LIVE=$(head -c 1800 "${{ env.LIVE_SUBDOMAINS_FILE }}" || echo "")
          MESSAGE="âœ… **Subfinder Complete**\n**Domain:** ${{ env.DOMAIN }}\n**Subdomains Found:** ${{ env.SUBDOMAINS_FOUND }}\n**Live:** ${{ env.LIVE_SUBDOMAINS_FOUND }}\n\n**Sample Subdomains:**\n\`\`\`\n$SUBS\n\`\`\`\n\n**Sample Live:**\n\`\`\`\n$LIVE\n\`\`\`"
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
            "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Run Waymore on Live Subdomains
        run: |
          set -e
          WAY_OUTPUT_DIR="waymore_output_${{ env.WORK_PREFIX }}"
          mkdir -p "$WAY_OUTPUT_DIR"
          INPUT="${{ env.LIVE_SUBDOMAINS_FILE }}"
          WAY_RESULT="waymore-urls_${{ env.WORK_PREFIX }}.txt"
          # if no live hosts, still attempt to run waymore on root domain (optional)
          if [ ! -s "$INPUT" ]; then
            echo "No live subdomains detected; running waymore on the root domain as fallback"
            waymore -i "${{ env.DOMAIN }}" -mode U -o "$WAY_OUTPUT_DIR" || true
          else
            while IFS= read -r host || [ -n "$host" ]; do
              # skip empty lines
              [ -z "$host" ] && continue
              echo "ðŸ”Ž Running Waymore for: $host"
              # use -mode U to collect URLs, adjust -p (pages) and -e (extensions) as needed
              waymore -i "$host" -mode U -o "$WAY_OUTPUT_DIR" || true
              # avoid being too aggressive
              sleep 1
            done < "$INPUT"
          fi
          # combine results
          find "$WAY_OUTPUT_DIR" -type f -name "*.txt" -exec cat {} \; | sort -u > "$WAY_RESULT" || touch "$WAY_RESULT"
          echo "WAYMORE_RESULTS_FILE=$WAY_RESULT" >> $GITHUB_ENV
          URLCOUNT=$(wc -l < "$WAY_RESULT" || echo 0)
          echo "URLS_FOUND=$URLCOUNT" >> $GITHUB_ENV

      - name: Notify Waymore Summary
        run: |
          if [ "${{ env.URLS_FOUND }}" -gt 0 ]; then
            MESSAGE="ðŸŒ **Waymore Complete**\n**Domain:** ${{ env.DOMAIN }}\n**URLs Found:** ${{ env.URLS_FOUND }}\n**File:** waymore-urls_${{ env.WORK_PREFIX }}.txt"
          else
            MESSAGE="ðŸŒ **Waymore Complete**\n**Domain:** ${{ env.DOMAIN }}\nNo URLs found."
          fi
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
            "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Prepare Targets for Nuclei
        run: |
          set -e
          # Decide targets: prefer waymore URLs if any; also run baseline on live hosts
          NUCL_TARGETS_WAY="nuclei-targets-waymore_${{ env.WORK_PREFIX }}.txt"
          NUCL_TARGETS_HOSTS="nuclei-targets-hosts_${{ env.WORK_PREFIX }}.txt"
          WAY_FILE="${{ env.WAYMORE_RESULTS_FILE }}"
          LIVE_FILE="${{ env.LIVE_SUBDOMAINS_FILE }}"

          # Filter and prepare
          if [ -s "$WAY_FILE" ]; then
            # Optionally filter certain extensions to reduce noise (change regex as needed)
            grep -E "http(s)?://" "$WAY_FILE" | sort -u > "$NUCL_TARGETS_WAY" || cp "$WAY_FILE" "$NUCL_TARGETS_WAY"
          else
            touch "$NUCL_TARGETS_WAY"
          fi

          if [ -s "$LIVE_FILE" ]; then
            # if httpx output contains status codes or extra columns, try to keep host/url
            sort -u "$LIVE_FILE" > "$NUCL_TARGETS_HOSTS"
          else
            touch "$NUCL_TARGETS_HOSTS"
          fi

          echo "NUCL_TARGETS_WAY=$NUCL_TARGETS_WAY" >> $GITHUB_ENV
          echo "NUCL_TARGETS_HOSTS=$NUCL_TARGETS_HOSTS" >> $GITHUB_ENV

      - name: Run Nuclei on Waymore URLs (deep)
        run: |
          set -e
          NUCL_OUT_WAY="nuclei-waymore-results_${{ env.WORK_PREFIX }}.txt"
          if [ -s "${{ env.NUCL_TARGETS_WAY }}" ]; then
            echo "Running nuclei on waymore URLs..."
            nuclei -l "${{ env.NUCL_TARGETS_WAY }}" -severity critical,high,medium -silent -o "$NUCL_OUT_WAY" -rl 150 -rate-limit 50 || true
          else
            touch "$NUCL_OUT_WAY"
          fi
          echo "NUC_WAY_FILE=$NUCL_OUT_WAY" >> $GITHUB_ENV
          WAY_VULNS=$(wc -l < "$NUCL_OUT_WAY" || echo 0)
          echo "WAY_VULNS_FOUND=$WAY_VULNS" >> $GITHUB_ENV

      - name: Run Nuclei on Live Hosts (surface)
        run: |
          set -e
          NUCL_OUT_HOSTS="nuclei-hosts-results_${{ env.WORK_PREFIX }}.txt"
          if [ -s "${{ env.NUCL_TARGETS_HOSTS }}" ]; then
            echo "Running nuclei on live hosts..."
            nuclei -l "${{ env.NUCL_TARGETS_HOSTS }}" -severity critical,high -silent -o "$NUCL_OUT_HOSTS" -rl 100 -rate-limit 40 || true
          else
            touch "$NUCL_OUT_HOSTS"
          fi
          echo "NUC_HOSTS_FILE=$NUCL_OUT_HOSTS" >> $GITHUB_ENV
          HOST_VULNS=$(wc -l < "$NUCL_OUT_HOSTS" || echo 0)
          echo "HOST_VULNS_FOUND=$HOST_VULNS" >> $GITHUB_ENV

      - name: Notify Nuclei Summary
        run: |
          total_vulns=$(( ${WAY_VULNS:-0} + ${HOST_VULNS:-0} ))
          if [ "$total_vulns" -gt 0 ]; then
            MESSAGE="ðŸš¨ **Vulnerabilities Found!**\n**Domain:** ${{ env.DOMAIN }}\n**Waymore URLs vulns:** ${WAY_VULNS}\n**Live hosts vulns:** ${HOST_VULNS}\n**Total:** $total_vulns\nUploading results as artifacts."
          else
            MESSAGE="âœ… **Nuclei Complete**\n**Domain:** ${{ env.DOMAIN }}\nNo critical/high/medium vulnerabilities found."
          fi
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
            "${{ env.DISCORD_WEBHOOK }}" || true

      - name: Send Individual Vulnerabilities to Discord (waymore)
        if: ${{ env.WAY_VULNS_FOUND }} != '0'
        run: |
          set -e
          FILE="${{ env.NUC_WAY_FILE }}"
          if [ -s "$FILE" ]; then
            while IFS= read -r vuln || [ -n "$vuln" ]; do
              [ -z "$vuln" ] && continue
              MESSAGE="ðŸš¨ **Vulnerability (Waymore URL)**\n**Domain:** ${{ env.DOMAIN }}\n\`\`\`\n$vuln\n\`\`\`"
              curl -s -X POST -H "Content-Type: application/json" \
                -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
                "${{ env.DISCORD_WEBHOOK }}" || true
              sleep 1
            done < "$FILE"
          fi

      - name: Send Individual Vulnerabilities to Discord (hosts)
        if: ${{ env.HOST_VULNS_FOUND }} != '0'
        run: |
          set -e
          FILE="${{ env.NUC_HOSTS_FILE }}"
          if [ -s "$FILE" ]; then
            while IFS= read -r vuln || [ -n "$vuln" ]; do
              [ -z "$vuln" ] && continue
              MESSAGE="ðŸš¨ **Vulnerability (Live Host)**\n**Domain:** ${{ env.DOMAIN }}\n\`\`\`\n$vuln\n\`\`\`"
              curl -s -X POST -H "Content-Type: application/json" \
                -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
                "${{ env.DISCORD_WEBHOOK }}" || true
              sleep 1
            done < "$FILE"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: scan-results-${{ env.WORK_PREFIX }}
          path: |
            subdomains_${{ env.WORK_PREFIX }}.txt
            live-subdomains_${{ env.WORK_PREFIX }}.txt
            waymore-urls_${{ env.WORK_PREFIX }}.txt
            nuclei-waymore-results_${{ env.WORK_PREFIX }}.txt
            nuclei-hosts-results_${{ env.WORK_PREFIX }}.txt

      - name: Final Notification
        run: |
          MESSAGE="ðŸ **Scan Finished**\n**Domain:** ${{ env.DOMAIN }}\n**Run ID:** ${{ env.WORK_PREFIX }}\nArtifacts uploaded to the workflow run."
          curl -s -X POST -H "Content-Type: application/json" \
            -d "{\"content\": $(echo "$MESSAGE" | jq -Rs .)}" \
            "${{ env.DISCORD_WEBHOOK }}" || true
