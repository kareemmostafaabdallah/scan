name: Subdomain

on:
  workflow_dispatch:
    inputs:
      domain:
        description: 'Domain to scan (مثل: example.com)'
        required: true
        default: 'example.com'

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Install Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq > /dev/null
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/projectdiscovery/httpx/cmd/httpx@latest
          go install github.com/projectdiscovery/nuclei/v3/cmd/nuclei@latest

      - name: Validate Discord Webhook
        run: |
          if [ -z "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            echo "ERROR: أضف secret اسمه DISCORD_WEBHOOK"
            exit 1
          fi

      - name: Set Domain
        run: echo "DOMAIN=${{ inputs.domain }}" >> $GITHUB_ENV

      - name: Notify Start
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{
              "content": "**بدء السكان الآن**",
              "embeds": null,
              "content": "**بدء السكان الآن**\n**الدومين:** `'${{ env.DOMAIN }}'`\n**الوقت:** <t:$(date +%s):F>"
            }'

      - name: Subdomain Enumeration
        run: |
          subfinder -d ${{ env.DOMAIN }} -all -silent -o subfinder.txt
          curl -s "https://chaos.projectdiscovery.io/?q=${{ env.DOMAIN }}" | jq -r '.[].subdomain' 2>/dev/null >> chaos.txt || true
          curl -s "https://crt.sh/?q=%.${{ env.DOMAIN }}&output=json" | jq -r '.[].name_value' 2>/dev/null | tr '[:upper:]' '[:lower:]' | sed 's/^*.//' >> crtsh.txt || true
          cat subfinder.txt chaos.txt crtsh.txt 2>/dev/null | sort -u > all_subs.txt
          echo "TOTAL_SUBS=$(wc -l < all_subs.txt)" >> $GITHUB_ENV

      - name: Probe Live Hosts
        run: |
          httpx -l all_subs.txt -silent -title -status-code -threads 300 -timeout 12 -o alive.txt
          echo "LIVE=$(wc -l < alive.txt || echo 0)" >> $GITHUB_ENV

      - name: Nuclei Scan
        run: |
          nuclei -update-templates -silent
          nuclei -l alive.txt -severity critical,high,medium -es info -c 50 -rl 150 -retries 2 -jsonl -o results.jsonl -silent
          jq -r 'select(.info.severity != null) | "[.info.severity | ascii_upcase] .template-id → .matched-at [.info.name]"' results.jsonl > vulns.txt 2>/dev/null || true
          echo "VULNS=$(wc -l < vulns.txt || echo 0)" >> $GITHUB_ENV

      - name: Notify Subdomains
        run: |
          SAMPLE=$(head -30 alive.txt | cut -d' ' -f1 | sed 's/^/• /' | paste -sd '' -)
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -d $'{"content": "**تم العثور على سابدومينز حية**\n**الدومين:** `'${{ env.DOMAIN }}'`\n**الكل:** ${{ env.TOTAL_SUBS }} │ **الحية:** ${{ env.LIVE }}\n```\n'"$SAMPLE"'$SAMPLE\n```"}'

      - name: Notify No Vulnerabilities
        if: env.VULNS == 0
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -d '{"content": "**Nuclei انتهى**\n**الدومين:** `'${{ env.DOMAIN }}'`\nلا توجد ثغرات Critical/High/Medium"}'

      - name: Notify Found Vulnerabilities
        if: env.VULNS > 0
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -d '{"content": "**تم اكتشاف ${{ env.VULNS }} ثغرة خطيرة!**\nجاري إرسال التفاصيل…"}'

      - name: Send Each Vulnerability
        if: env.VULNS > 0
        run: |
          while IFS= read -r line; do
            curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
              -d "{\"content\": \"**ثغرة جديدة**\n\`\`\`\n$line\n\`\`\`\"}"
            sleep 1
          done < vulns.txt

      - name: Final Message
        run: |
          curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
            -d '{"content": "**السكان انتهى تمامًا**\n**الدومين:** `'${{ env.DOMAIN }}'`\n**الحية:** ${{ env.LIVE }} │ **الثغرات:** ${{ env.VULNS }}\nhttps://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: scan-${{ env.DOMAIN }}-${{ github.run_id }}
          path: |
            all_subs.txt
            alive.txt
            results.jsonl
            vulns.txt
